<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ä¸­é‡‘æ‰€è‚¡æŒ‡æœŸè´§åŸºå·®ç›‘æ§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Microsoft Yahei", sans-serif;
        }
        body {
            background: #f5f5f5;
            padding: 8px;
            font-size: 14px;
        }
        /* åˆçº¦åˆ‡æ¢æ ‡ç­¾æ  */
        .contract-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
            background: #fff;
            border-radius: 6px;
            padding: 4px;
        }
        .tab-item {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            border-radius: 4px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            user-select: none;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
        }
        .tab-item.active {
            background: #4CAF50;
            color: #fff;
        }
        .tab-item:focus {
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }
        /* é—­å¸‚æç¤º */
        .close-market-tip {
            background: #fff3cd;
            color: #856404;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
            margin-bottom: 8px;
            border: 1px solid #ffeeba;
        }
        /* é¡¶éƒ¨ä¿¡æ¯æ  */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            background: #fff;
            padding: 6px 8px;
            border-radius: 6px;
        }
        .top-bar .left {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .top-bar .right {
            text-align: right;
        }
        .top-bar .time {
            font-size: 12px;
            color: #666;
        }
        .top-bar .change {
            font-size: 14px;
            color: #e63946;
        }
        .top-bar .price {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        /* æ ¸å¿ƒè¡¨æ ¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 12px;
            font-size: 13px;
        }
        .data-table th, .data-table td {
            border: 1px solid #eee;
            padding: 4px 3px;
            text-align: center;
            line-height: 1.2;
        }
        .data-table th {
            background: #f8f8f8;
            font-weight: 600;
            color: #333;
            font-size: 12px;
            padding: 5px 0;
        }
        .data-table .row-title {
            text-align: left;
            padding-left: 8px;
            color: #666;
            white-space: nowrap;
        }
        /* æ¶¨è·Œé¢œè‰² */
        .rise {
            color: #e63946 !important;
        }
        .fall {
            color: #1d3557 !important;
        }
        /* å¼€å…³æ ·å¼ */
        .switch-group {
            margin-bottom: 10px;
            background: #fff;
            padding: 8px;
            border-radius: 6px;
        }
        .switch-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #eee;
        }
        .switch-item:last-child {
            border-bottom: none;
        }
        .switch-item span {
            font-size: 14px;
            color: #333;
        }
        .switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #ddd;
            border-radius: 12px;
            cursor: pointer;
        }
        .switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            top: 2px;
            left: 2px;
            transition: left 0.2s;
        }
        .switch.active::after {
            left: 22px;
        }
        .switch.active {
            background: #4CAF50;
        }
        /* åº•éƒ¨æŒ‰é’® */
        .btn-group {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        .btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
            color: #666;
            padding: 8px 0;
            flex: 1;
            max-width: 80px;
        }
        .btn .icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4CAF50;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 4px;
            font-size: 18px;
        }
        .btn.manual .icon {
            background: #ff9800;
        }
        .btn.record .icon {
            background: #2196F3;
        }
        /* æ•°æ®æºæç¤º */
        .tip {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 6px 10px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            font-size: 12px;
            border-radius: 4px;
            display: none;
            z-index: 999;
        }
        /* å°å±é€‚é… */
        @media (max-width: 375px) {
            .data-table th, .data-table td {
                font-size: 12px;
                padding: 3px 2px;
            }
            .tab-item {
                font-size: 13px;
                padding: 6px 0;
            }
        }
    </style>
</head>
<body>
    <!-- æ•°æ®æºæç¤º -->
    <div class="tip" id="dataSourceTip"></div>

    <!-- é—­å¸‚æç¤ºæ  -->
    <div class="close-market-tip" id="closeMarketTip">å½“å‰ä¸ºé—­å¸‚æ—¶é—´ï¼Œæ˜¾ç¤ºæœ€æ–°ç¼“å­˜æ•°æ®ï¼Œå¼€å¸‚åè‡ªåŠ¨æ›´æ–°å®æ—¶æ•°æ®</div>

    <!-- åˆçº¦åˆ‡æ¢æ ‡ç­¾æ  -->
    <div class="contract-tabs">
        <div class="tab-item active" tabindex="0" data-code="IF">IF</div>
        <div class="tab-item" tabindex="0" data-code="IH">IH</div>
        <div class="tab-item" tabindex="0" data-code="IC">IC</div>
        <div class="tab-item" tabindex="0" data-code="IM">IM</div>
    </div>

    <!-- é¡¶éƒ¨ä¿¡æ¯ -->
    <div class="top-bar">
        <div class="left" id="currentContract">IF</div>
        <div class="right">
            <div class="time" id="updateTime">2025/12/26 16:11:43</div>
            <div class="change" id="totalChange">+14.70</div>
            <div class="price" id="totalPrice">4657.24</div>
        </div>
    </div>

    <!-- æ ¸å¿ƒæ•°æ®è¡¨æ ¼ -->
    <table class="data-table">
        <thead>
            <tr>
                <th></th>
                <th>2601</th>
                <th>2602</th>
                <th>2603</th>
                <th>2606</th>
            </tr>
        </thead>
        <tbody>
            <tr><td class="row-title">ä»·æ ¼</td><td id="price_2601">4657.0</td><td id="price_2602">4642.0</td><td id="price_2603">4638.4</td><td id="price_2606">4591.0</td></tr>
            <tr><td class="row-title">æ¶¨è·Œ</td><td id="change_2601" class="rise">25.0</td><td id="change_2602" class="rise">23.4</td><td id="change_2603" class="rise">27.8</td><td id="change_2606" class="rise">29.2</td></tr>
            <tr><td class="row-title">æœªå¹³ä»“é‡</td><td id="open_interest_2601">63400</td><td id="open_interest_2602">4104</td><td id="open_interest_2603">175215</td><td id="open_interest_2606">45186</td></tr>
            <tr><td class="row-title">æˆäº¤é‡</td><td id="volume_2601">32939</td><td id="volume_2602">3163</td><td id="volume_2603">70821</td><td id="volume_2606">11923</td></tr>
            <tr><td class="row-title">å‰©ä½™å¤©æ•°</td><td id="days_left_2601">22</td><td id="days_left_2602">57</td><td id="days_left_2603">85</td><td id="days_left_2606">176</td></tr>
            <tr><td class="row-title">åŸºå·®å˜åŒ–</td><td id="basis_change_2601" class="fall">-10.30</td><td id="basis_change_2602" class="fall">-8.70</td><td id="basis_change_2603" class="fall">-13.10</td><td id="basis_change_2606" class="fall">-14.50</td></tr>
            <tr><td class="row-title">åŸºå·®</td><td id="basis_2601">0.24</td><td id="basis_2602">15.24</td><td id="basis_2603">18.84</td><td id="basis_2606">66.24</td></tr>
            <tr><td class="row-title">å¹´åŒ–åŸºå·®</td><td id="annual_basis_2601">0.09%</td><td id="annual_basis_2602">2.10%</td><td id="annual_basis_2603">1.74%</td><td id="annual_basis_2606">2.99%</td></tr>
            <tr><td class="row-title">æ—¥å¹³å‡æŠ˜ä»·</td><td id="daily_discount_2601">0.01</td><td id="daily_discount_2602">0.27</td><td id="daily_discount_2603">0.22</td><td id="daily_discount_2606">0.38</td></tr>
            <tr><td class="row-title">å¹´åŒ–æ¯ç‚¹æŠ˜</td><td id="annual_point_discount_2601">2.81</td><td id="annual_point_discount_2602">7.25</td><td id="annual_point_discount_2603">10.80</td><td id="annual_point_discount_2606">22.14</td></tr>
        </tbody>
    </table>

    <!-- å¼€å…³ç»„ -->
    <div class="switch-group">
        <div class="switch-item">
            <span>ç›¸å¯¹åŸºå·®æŒ‡ç¤º</span>
            <div class="switch" id="switch1"></div>
        </div>
        <div class="switch-item">
            <span>æ¢æœˆè¾…åŠ©è®¡ç®—</span>
            <div class="switch" id="switch2"></div>
        </div>
        <div class="switch-item">
            <span>å¿«é€Ÿåˆ·æ–°</span>
            <div class="switch" id="switch3"></div>
        </div>
    </div>

    <!-- åº•éƒ¨æŒ‰é’® -->
    <div class="btn-group">
        <div class="btn auto">
            <div class="icon">A</div>
            <div>è‡ªåŠ¨è·å–</div>
        </div>
        <div class="btn manual">
            <div class="icon">P</div>
            <div>æ‰‹åŠ¨è¾“å…¥</div>
        </div>
        <div class="btn record">
            <div class="icon">ğŸ“</div>
            <div>æ›´æ–°è®°å½•</div>
        </div>
    </div>

    <script>
        // ========== å…¨å±€é…ç½®ï¼ˆæ–°å¢æœ¬åœ°å­˜å‚¨å’Œç¼“å­˜æœºåˆ¶ï¼‰ ==========
        const CONFIG = {
            // åˆçº¦åŸºç¡€é…ç½®+å…œåº•æ•°æ®
            contractConfig: {
                IF: { 
                    name: 'æ²ªæ·±300è‚¡æŒ‡æœŸè´§', 
                    spotPrice: 4657.24,
                    fallbackData: { // IFå…œåº•æ•°æ®
                        '2601': { price: 4657.0, change: 25.0, openInterest: 63400, volume: 32939 },
                        '2602': { price: 4642.0, change: 23.4, openInterest: 4104, volume: 3163 },
                        '2603': { price: 4638.4, change: 27.8, openInterest: 175215, volume: 70821 },
                        '2606': { price: 4591.0, change: 29.2, openInterest: 45186, volume: 11923 }
                    }
                },
                IH: { 
                    name: 'ä¸Šè¯50è‚¡æŒ‡æœŸè´§', 
                    spotPrice: 2380.56,
                    fallbackData: { // IHå…œåº•æ•°æ®
                        '2601': { price: 2382.6, change: 12.3, openInterest: 58200, volume: 28560 },
                        '2602': { price: 2378.8, change: 8.5, openInterest: 3890, volume: 2650 },
                        '2603': { price: 2375.2, change: 10.1, openInterest: 168500, volume: 65400 },
                        '2606': { price: 2360.5, change: 15.7, openInterest: 42800, volume: 10800 }
                    }
                },
                IC: { 
                    name: 'ä¸­è¯500è‚¡æŒ‡æœŸè´§', 
                    spotPrice: 7820.15,
                    fallbackData: { // ICå…œåº•æ•°æ®
                        '2601': { price: 7825.5, change: 45.2, openInterest: 72600, volume: 41200 },
                        '2602': { price: 7810.8, change: 30.5, openInterest: 5200, volume: 4800 },
                        '2603': { price: 7798.6, change: 38.9, openInterest: 185600, volume: 82500 },
                        '2606': { price: 7750.2, change: 55.8, openInterest: 51200, volume: 15600 }
                    }
                },
                IM: { 
                    name: 'ä¸­è¯1000è‚¡æŒ‡æœŸè´§', 
                    spotPrice: 6510.88,
                    fallbackData: { // IMå…œåº•æ•°æ®
                        '2601': { price: 6518.3, change: 38.5, openInterest: 68500, volume: 36800 },
                        '2602': { price: 6505.6, change: 25.8, openInterest: 4600, volume: 3900 },
                        '2603': { price: 6492.4, change: 32.1, openInterest: 178900, volume: 75600 },
                        '2606': { price: 6450.8, change: 48.9, openInterest: 48500, volume: 13200 }
                    }
                }
            },
            currentContract: 'IF', 
            contracts: ['2601', '2602', '2603', '2606'], 
            refreshInterval: 2000, 
            timeout: 1500, 
            currentSource: 'sina', 
            sourceStatus: { sina: true, eastmoney: true }, 
            lastBasisData: {}, 
            refreshTimer: null,
            isMarketOpen: false // é»˜è®¤é—­å¸‚
        };

        // ========== æœ¬åœ°å­˜å‚¨å·¥å…·å‡½æ•° ==========
        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveToLocalStorage(contract, data) {
            try {
                const storedData = {
                    data: data,
                    timestamp: new Date().getTime()
                };
                localStorage.setItem(`future_data_${contract}`, JSON.stringify(storedData));
            } catch (e) {
                console.error('ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨è·å–æ•°æ®
        function getFromLocalStorage(contract) {
            try {
                const storedData = localStorage.getItem(`future_data_${contract}`);
                if (storedData) {
                    return JSON.parse(storedData);
                }
            } catch (e) {
                console.error('ä»æœ¬åœ°å­˜å‚¨è·å–æ•°æ®å¤±è´¥:', e);
            }
            return null;
        }

        // ========== å·¥å…·å‡½æ•° ==========
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            const second = String(now.getSeconds()).padStart(2, '0');
            return `${year}/${month}/${day} ${hour}:${minute}:${second}`;
        }

        // è®¡ç®—åˆçº¦å‰©ä½™å¤©æ•°
        function calculateDaysLeft(contractMonth) {
            const year = 2026;
            const month = parseInt(contractMonth.slice(0, 2)) - 1;
            let fridayCount = 0;
            let targetDate = null;
            
            for (let day = 1; day <= 31; day++) {
                const date = new Date(year, month, day);
                if (date.getMonth() !== month) break;
                if (date.getDay() === 5) {
                    fridayCount++;
                    if (fridayCount === 3) {
                        targetDate = date;
                        break;
                    }
                }
            }

            const now = new Date();
            const diffTime = targetDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? diffDays : 0;
        }

        // æ˜¾ç¤ºæç¤º
        function showSourceTip(text) {
            const tip = document.getElementById('dataSourceTip');
            tip.textContent = text;
            tip.style.display = 'block';
            setTimeout(() => tip.style.display = 'none', 2000);
        }

        // æ£€æŸ¥æ˜¯å¦å¼€å¸‚ï¼ˆä¸­é‡‘æ‰€è‚¡æŒ‡æœŸè´§äº¤æ˜“æ—¶é—´ï¼š9:30-11:30ï¼Œ13:00-15:00ï¼Œå·¥ä½œæ—¥ï¼‰
        function checkMarketStatus() {
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const day = now.getDay();

            // æ’é™¤å‘¨æœ«
            if (day === 0 || day === 6) {
                CONFIG.isMarketOpen = false;
                return false;
            }

            // æ£€æŸ¥äº¤æ˜“æ—¶é—´æ®µ
            const isMorning = (hour === 9 && minute >= 30) || (hour > 9 && hour < 11) || (hour === 11 && minute <= 30);
            const isAfternoon = (hour === 13 && minute >= 0) || (hour > 13 && hour < 15) || (hour === 15 && minute <= 0);
            
            CONFIG.isMarketOpen = isMorning || isAfternoon;
            // æ›´æ–°é—­å¸‚æç¤ºæ˜¾ç¤ºçŠ¶æ€
            document.getElementById('closeMarketTip').style.display = CONFIG.isMarketOpen ? 'none' : 'block';
            return CONFIG.isMarketOpen;
        }

        // ========== æ•°æ®è·å–ï¼ˆæ–°å¢æœ¬åœ°ç¼“å­˜é€»è¾‘ï¼‰ ==========
        // æ–°æµªè´¢ç»æ•°æ®è·å–
        function fetchSinaData() {
            return new Promise((resolve, reject) => {
                // é—­å¸‚æ—¶å°è¯•è·å–æœ¬åœ°ç¼“å­˜æ•°æ®
                if (!checkMarketStatus()) {
                    const cachedData = getFromLocalStorage(CONFIG.currentContract);
                    if (cachedData) {
                        // å¦‚æœæœ‰ç¼“å­˜æ•°æ®ï¼Œä½¿ç”¨ç¼“å­˜
                        resolve(cachedData.data);
                        return;
                    } else {
                        // æ²¡æœ‰ç¼“å­˜æ•°æ®æ‰ä½¿ç”¨å…œåº•æ•°æ®
                        resolve(CONFIG.contractConfig[CONFIG.currentContract].fallbackData);
                        return;
                    }
                }

                const contractCodes = CONFIG.contracts.map(month => `${CONFIG.currentContract}${month}.CFE`).join(',');
                const url = `http://hq.sinajs.cn/list=${contractCodes}?r=${Math.random()}`;

                const script = document.createElement('script');
                script.src = url;
                script.async = true;

                const timeoutTimer = setTimeout(() => {
                    script.remove();
                    CONFIG.sourceStatus.sina = false;
                    // è¶…æ—¶å°è¯•ä½¿ç”¨ç¼“å­˜æ•°æ®
                    const cachedData = getFromLocalStorage(CONFIG.currentContract);
                    if (cachedData) {
                        resolve(cachedData.data);
                    } else {
                        resolve(CONFIG.contractConfig[CONFIG.currentContract].fallbackData);
                    }
                }, CONFIG.timeout);

                window.handleSinaData = function() {
                    clearTimeout(timeoutTimer);
                    script.remove();
                    
                    const result = {};
                    let hasValidData = false;
                    CONFIG.contracts.forEach(month => {
                        const code = `hq_str_${CONFIG.currentContract}${month}.CFE`;
                        if (window[code]) {
                            const dataArr = window[code].split('=')[1].replace(/"/g, '').split(',');
                            result[month] = {
                                price: parseFloat(dataArr[3]) || 0,
                                change: parseFloat(dataArr[21]) || 0,
                                openInterest: parseInt(dataArr[10]) || 0,
                                volume: parseInt(dataArr[9]) || 0
                            };
                            hasValidData = true;
                        }
                    });

                    // æ¥å£æœ‰æœ‰æ•ˆæ•°æ®åˆ™ä¿å­˜åˆ°æœ¬åœ°å¹¶è¿”å›
                    if (hasValidData) {
                        CONFIG.currentSource = 'sina';
                        showSourceTip(`å½“å‰æ•°æ®æºï¼šæ–°æµªè´¢ç»ï¼ˆ${CONFIG.currentContract}ï¼‰`);
                        saveToLocalStorage(CONFIG.currentContract, result);
                        resolve(result);
                    } else {
                        // æ— æœ‰æ•ˆæ•°æ®åˆ™å°è¯•ä½¿ç”¨ç¼“å­˜
                        const cachedData = getFromLocalStorage(CONFIG.currentContract);
                        if (cachedData) {
                            resolve(cachedData.data);
                        } else {
                            resolve(CONFIG.contractConfig[CONFIG.currentContract].fallbackData);
                        }
                    }
                };

                script.onload = window.handleSinaData;
                script.onerror = () => {
                    clearTimeout(timeoutTimer);
                    script.remove();
                    CONFIG.sourceStatus.sina = false;
                    // åŠ è½½å¤±è´¥å°è¯•ä½¿ç”¨ç¼“å­˜
                    const cachedData = getFromLocalStorage(CONFIG.currentContract);
                    if (cachedData) {
                        resolve(cachedData.data);
                    } else {
                        resolve(CONFIG.contractConfig[CONFIG.currentContract].fallbackData);
                    }
                };
                document.body.appendChild(script);
            });
        }

        // ä¸œæ–¹è´¢å¯Œæ•°æ®è·å–ï¼ˆå¤‡ç”¨ï¼‰
        function fetchEastMoneyData() {
            return new Promise((resolve, reject) => {
                // é—­å¸‚æ—¶å°è¯•è·å–æœ¬åœ°ç¼“å­˜æ•°æ®
                if (!checkMarketStatus()) {
                    const cachedData = getFromLocalStorage(CONFIG.currentContract);
                    if (cachedData) {
                        resolve(cachedData.data);
                        return;
                    } else {
                        resolve(CONFIG.contractConfig[CONFIG.currentContract].fallbackData);
                        return;
                    }
                }

                const secids = CONFIG.contracts.map(month => `1.${CONFIG.currentContract}${month}`).join(',');
                const url = `https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&invt=2&fields=f2,f3,f10,f9&secid=${secids}&_=${Date.now()}`;
                
                const script = document.createElement('script');
                script.src = `${url}&callback=handleEastMoneyData`;
                script.async = true;

                const timeoutTimer = setTimeout(() => {
                    script.remove();
                    CONFIG.sourceStatus.eastmoney = false;
                    // è¶…æ—¶å°è¯•ä½¿ç”¨ç¼“å­˜
                    const cachedData = getFromLocalStorage(CONFIG.currentContract);
                    if (cachedData) {
                        resolve(cachedData.data);
                    } else {
                        resolve(CONFIG.contractConfig[CONFIG.currentContract].fallbackData);
                    }
                }, CONFIG.timeout);

                window.handleEastMoneyData = function(res) {
                    clearTimeout(timeoutTimer);
                    script.remove();
                    
                    const result = {};
                    let hasValidData = false;
                    if (res.data?.diff && res.data.diff.length > 0) {
                        res.data.diff.forEach(item => {
                            const month = item.f13?.slice(-4) || '';
                            if (month) {
                                result[month] = {
                                    price: parseFloat(item.f2) || 0,
                                    change: parseFloat(item.f3) || 0,
                                    openInterest: parseInt(item.f10) || 0,
                                    volume: parseInt(item.f9) || 0
                                };
                                hasValidData = true;
                            }
                        });
                    }

                    // æœ‰æ•°æ®åˆ™ä¿å­˜åˆ°æœ¬åœ°å¹¶è¿”å›
                    if (hasValidData) {
                        CONFIG.currentSource = 'eastmoney';
                        showSourceTip(`å½“å‰æ•°æ®æºï¼šä¸œæ–¹è´¢å¯Œï¼ˆ${CONFIG.currentContract}ï¼‰`);
                        saveToLocalStorage(CONFIG.currentContract, result);
                        resolve(result);
                    } else {
                        // æ— æ•°æ®åˆ™å°è¯•ä½¿ç”¨ç¼“å­˜
                        const cachedData = getFromLocalStorage(CONFIG.currentContract);
                        if (cachedData) {
                            resolve(cachedData.data);
                        } else {
                            resolve(CONFIG.contractConfig[CONFIG.currentContract].fallbackData);
                        }
                    }
                };

                script.onerror = () => {
                    clearTimeout(timeoutTimer);
                    script.remove();
                    CONFIG.sourceStatus.eastmoney = false;
                    // å¤±è´¥å°è¯•ä½¿ç”¨ç¼“å­˜
                    const cachedData = getFromLocalStorage(CONFIG.currentContract);
                    if (cachedData) {
                        resolve(cachedData.data);
                    } else {
                        resolve(CONFIG.contractConfig[CONFIG.currentContract].fallbackData);
                    }
                };
                document.body.appendChild(script);
            });
        }

        // æ ¸å¿ƒæ•°æ®è·å–ï¼ˆä¸»å¤‡åˆ‡æ¢+ç¼“å­˜+å…œåº•ï¼‰
        async function fetchData() {
            try {
                let data;
                if (CONFIG.sourceStatus.sina) {
                    data = await fetchSinaData();
                } else if (CONFIG.sourceStatus.eastmoney) {
                    data = await fetchEastMoneyData();
                } else {
                    // æ‰€æœ‰æ•°æ®æºä¸å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨ç¼“å­˜
                    const cachedData = getFromLocalStorage(CONFIG.currentContract);
                    if (cachedData) {
                        data = cachedData.data;
                    } else {
                        data = CONFIG.contractConfig[CONFIG.currentContract].fallbackData;
                    }
                }
                return data;
            } catch (err) {
                console.error('æ•°æ®è·å–å¼‚å¸¸ï¼š', err.message);
                // å¼‚å¸¸æ—¶å°è¯•ä½¿ç”¨ç¼“å­˜
                const cachedData = getFromLocalStorage(CONFIG.currentContract);
                if (cachedData) {
                    return cachedData.data;
                }
                return CONFIG.contractConfig[CONFIG.currentContract].fallbackData;
            }
        }

        // ========== æŒ‡æ ‡è®¡ç®—ä¸é¡µé¢æ›´æ–° ==========
        // è®¡ç®—è¡ç”ŸæŒ‡æ ‡
        function calculateIndicators(rawData) {
            const result = {};
            const spotPrice = CONFIG.contractConfig[CONFIG.currentContract].spotPrice;
            
            CONFIG.contracts.forEach(month => {
                const raw = rawData[month] || CONFIG.contractConfig[CONFIG.currentContract].fallbackData[month];
                const daysLeft = calculateDaysLeft(month);
                
                // åŸºå·® = ç°è´§ä»· - æœŸè´§ä»·
                const basis = (spotPrice - raw.price).toFixed(2);
                // åŸºå·®å˜åŒ–
                const lastBasisKey = `${CONFIG.currentContract}_${month}`;
                const lastBasis = CONFIG.lastBasisData[lastBasisKey] || basis;
                const basisChange = (basis - lastBasis).toFixed(2);
                // å¹´åŒ–åŸºå·®
                const annualBasis = daysLeft > 0 
                    ? ((basis / spotPrice) * (365 / daysLeft) * 100).toFixed(2) + '%'
                    : '0.00%';
                // æ—¥å¹³å‡æŠ˜ä»·/å¹´åŒ–æ¯ç‚¹æŠ˜
                const dailyDiscount = daysLeft > 0 ? (basis / daysLeft).toFixed(2) : 0;
                const annualPointDiscount = daysLeft > 0 ? (dailyDiscount * 365 / 10).toFixed(2) : 0;

                // ä¿å­˜åŸºå·®
                CONFIG.lastBasisData[lastBasisKey] = parseFloat(basis);

                result[month] = {
                    ...raw,
                    daysLeft,
                    basis,
                    basisChange,
                    annualBasis,
                    dailyDiscount,
                    annualPointDiscount
                };
            });
            return result;
        }

        // æ›´æ–°é¡µé¢
        function updateTable(calcData) {
            // æ›´æ–°é¡¶éƒ¨æ—¶é—´
            document.getElementById('updateTime').textContent = formatTime();
            // æ›´æ–°å½“å‰åˆçº¦åç§°
            document.getElementById('currentContract').textContent = CONFIG.currentContract;
            
            // æ›´æ–°è¡¨æ ¼æ•°æ®
            CONFIG.contracts.forEach(month => {
                const data = calcData[month] || {};
                // åŸºç¡€æ•°æ®
                document.getElementById(`price_${month}`).textContent = (data.price || 0).toFixed(1);
                document.getElementById(`open_interest_${month}`).textContent = data.openInterest || 0;
                document.getElementById(`volume_${month}`).textContent = data.volume || 0;
                document.getElementById(`days_left_${month}`).textContent = data.daysLeft || 0;
                
                // æ¶¨è·Œï¼ˆé¢œè‰²ï¼‰
                const changeEl = document.getElementById(`change_${month}`);
                changeEl.textContent = (data.change || 0).toFixed(1);
                changeEl.className = (data.change || 0) >= 0 ? 'rise' : 'fall';
                
                // åŸºå·®ç›¸å…³
                const basisChangeEl = document.getElementById(`basis_change_${month}`);
                basisChangeEl.textContent = data.basisChange || 0;
                basisChangeEl.className = parseFloat(data.basisChange || 0) >= 0 ? 'rise' : 'fall';
                
                document.getElementById(`basis_${month}`).textContent = data.basis || 0;
                document.getElementById(`annual_basis_${month}`).textContent = data.annualBasis || '0.00%';
                document.getElementById(`daily_discount_${month}`).textContent = data.dailyDiscount || 0;
                document.getElementById(`annual_point_discount_${month}`).textContent = data.annualPointDiscount || 0;
            });

            // æ›´æ–°é¡¶éƒ¨æ€»è§ˆï¼ˆå–2601åˆçº¦ï¼‰
            const mainData = calcData['2601'] || {};
            document.getElementById('totalChange').textContent = `+${(mainData.change || 0).toFixed(1)}`;
            document.getElementById('totalPrice').textContent = (mainData.price || 0).toFixed(2);
        }

        // ========== åˆçº¦åˆ‡æ¢é€»è¾‘ ==========
        function switchContract(contractCode) {
            // æ›´æ–°å½“å‰åˆçº¦
            CONFIG.currentContract = contractCode;
            
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.tab-item').forEach(item => {
                item.classList.toggle('active', item.dataset.code === contractCode);
            });
            
            // ç«‹å³åŠ è½½æ–°åˆçº¦æ•°æ®
            fetchData().then(rawData => {
                const calcData = calculateIndicators(rawData);
                updateTable(calcData);
            });
        }

        function initContractTabs() {
            const tabItems = document.querySelectorAll('.tab-item');
            
            // ç‚¹å‡»åˆ‡æ¢
            tabItems.forEach(item => {
                item.addEventListener('click', () => {
                    switchContract(item.dataset.code);
                });
                
                // é”®ç›˜æ”¯æŒ
                item.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        switchContract(item.dataset.code);
                    }
                });
            });
        }

        // ========== å¼€å…³åŠŸèƒ½åˆå§‹åŒ– ==========
        function initSwitches() {
            // å¼€å…³1ï¼šç›¸å¯¹åŸºå·®æŒ‡ç¤º
            document.getElementById('switch1').addEventListener('click', function() {
                this.classList.toggle('active');
                // è¿™é‡Œå¯ä»¥æ·»åŠ ç›¸å¯¹åŸºå·®æŒ‡ç¤ºçš„é€»è¾‘
                showSourceTip(`ç›¸å¯¹åŸºå·®æŒ‡ç¤ºï¼š${this.classList.contains('active') ? 'å¼€å¯' : 'å…³é—­'}`);
            });
            
            // å¼€å…³2ï¼šæ¢æœˆè¾…åŠ©è®¡ç®—
            document.getElementById('switch2').addEventListener('click', function() {
                this.classList.toggle('active');
                // è¿™é‡Œå¯ä»¥æ·»åŠ æ¢æœˆè¾…åŠ©è®¡ç®—çš„é€»è¾‘
                showSourceTip(`æ¢æœˆè¾…åŠ©è®¡ç®—ï¼š${this.classList.contains('active') ? 'å¼€å¯' : 'å…³é—­'}`);
            });
            
            // å¼€å…³3ï¼šå¿«é€Ÿåˆ·æ–°
            document.getElementById('switch3').addEventListener('click', function() {
                this.classList.toggle('active');
                // è°ƒæ•´åˆ·æ–°é¢‘ç‡
                CONFIG.refreshInterval = this.classList.contains('active') ? 1000 : 2000;
                restartRefreshTimer();
                showSourceTip(`å¿«é€Ÿåˆ·æ–°ï¼š${this.classList.contains('active') ? 'å¼€å¯' : 'å…³é—­'}`);
            });
        }

        // ========== åº•éƒ¨æŒ‰é’®åŠŸèƒ½ ==========
        function initButtons() {
            // è‡ªåŠ¨è·å–æŒ‰é’®
            document.querySelector('.btn.auto').addEventListener('click', function() {
                showSourceTip('å·²å¯ç”¨è‡ªåŠ¨è·å–æ¨¡å¼');
                restartRefreshTimer();
            });
            
            // æ‰‹åŠ¨è¾“å…¥æŒ‰é’®
            document.querySelector('.btn.manual').addEventListener('click', function() {
                showSourceTip('æ‰‹åŠ¨è¾“å…¥åŠŸèƒ½å¾…å®ç°');
                // è¿™é‡Œå¯ä»¥æ·»åŠ æ‰‹åŠ¨è¾“å…¥çš„é€»è¾‘
            });
            
            // æ›´æ–°è®°å½•æŒ‰é’®
            document.querySelector('.btn.record').addEventListener('click', function() {
                showSourceTip('æ›´æ–°è®°å½•åŠŸèƒ½å¾…å®ç°');
                // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´æ–°è®°å½•çš„é€»è¾‘
            });
        }

        // ========== åˆ·æ–°å®šæ—¶å™¨æ§åˆ¶ ==========
        function startRefreshTimer() {
            stopRefreshTimer();
            CONFIG.refreshTimer = setInterval(async () => {
                const rawData = await fetchData();
                const calcData = calculateIndicators(rawData);
                updateTable(calcData);
            }, CONFIG.refreshInterval);
        }

        function stopRefreshTimer() {
            if (CONFIG.refreshTimer) {
                clearInterval(CONFIG.refreshTimer);
                CONFIG.refreshTimer = null;
            }
        }

        function restartRefreshTimer() {
            stopRefreshTimer();
            startRefreshTimer();
        }

        // ========== åˆå§‹åŒ–åº”ç”¨ ==========
        function initApp() {
            // åˆå§‹åŒ–å„ç»„ä»¶
            initContractTabs();
            initSwitches();
            initButtons();
            
            // æ£€æŸ¥å¸‚åœºçŠ¶æ€
            checkMarketStatus();
            
            // é¦–æ¬¡åŠ è½½æ•°æ®
            fetchData().then(rawData => {
                const calcData = calculateIndicators(rawData);
                updateTable(calcData);
                
                // å¯åŠ¨åˆ·æ–°å®šæ—¶å™¨
                startRefreshTimer();
            });
        }

        // å¯åŠ¨åº”ç”¨
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
